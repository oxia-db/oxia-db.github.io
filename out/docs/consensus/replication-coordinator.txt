1:"$Sreact.fragment"
3:I[87555,[],""]
4:I[31295,[],""]
6:I[59665,[],"OutletBoundary"]
9:I[74911,[],"AsyncMetadataOutlet"]
b:I[59665,[],"ViewportBoundary"]
d:I[59665,[],"MetadataBoundary"]
f:I[26614,[],""]
:HL["/_next/static/css/69af9cb1c465c404.css","style"]
0:{"P":null,"b":"X0_M9nmBS-Z7MGngeXSH7","p":"","c":["","docs","consensus","replication-coordinator"],"i":false,"f":[[["",{"children":["docs",{"children":[["mdxPath","consensus/replication-coordinator","oc"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/69af9cb1c465c404.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],"$L2"]}],{"children":["docs",["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["mdxPath","consensus/replication-coordinator","oc"],["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L5",null,["$","$L6",null,{"children":["$L7","$L8",["$","$L9",null,{"promise":"$@a"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","TNWC248SBVWH-_V2gU1nvv",{"children":[["$","$Lb",null,{"children":"$Lc"}],null]}],["$","$Ld",null,{"children":"$Le"}]]}],false]],"m":"$undefined","G":["$f","$undefined"],"s":false,"S":true}
10:"$Sreact.suspense"
11:I[74911,[],"AsyncMetadata"]
e:["$","div",null,{"hidden":true,"children":["$","$10",null,{"fallback":null,"children":["$","$L11",null,{"promise":"$@12"}]}]}]
8:null
13:I[35776,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"ThemeConfigProvider"]
14:I[36666,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"LastUpdated"]
15:I[94013,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","904","static/chunks/904-ea4f3e266b412ec3.js","7177","static/chunks/app/layout-206d02a6d10581af.js"],"Search"]
16:I[51362,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","904","static/chunks/904-ea4f3e266b412ec3.js","7177","static/chunks/app/layout-206d02a6d10581af.js"],"ThemeProvider"]
17:I[66221,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"SkipNavLink"]
18:I[11226,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"ConfigProvider"]
19:I[6874,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],""]
1a:I[85396,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"ClientNavbar"]
1b:I[44502,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"MobileNav"]
2:["$","html",null,{"lang":"en","dir":"ltr","suppressHydrationWarning":true,"children":[["$","head",null,{"children":["$undefined",["$","style",null,{"children":":root {\n  --nextra-primary-hue: 212deg;\n  --nextra-primary-saturation: 100%;\n  --nextra-primary-lightness: 45%;\n  --nextra-bg: 250,250,250;\n  --nextra-content-width: 90rem;\n}\n.dark {\n  --nextra-primary-hue: 204deg;\n  --nextra-primary-saturation: 100%;\n  --nextra-primary-lightness: 55%;\n  --nextra-bg: 17,17,17;\n}\n::selection {\n  background: hsla(var(--nextra-primary-hue),var(--nextra-primary-saturation),var(--nextra-primary-lightness),.3);\n}\nhtml {\n  background: rgb(var(--nextra-bg));\n}"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: light)","content":"rgb(250,250,250)"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: dark)","content":"rgb(17,17,17)"}],["$","link",null,{"rel":"icon","href":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='.9em' font-size='90' text-anchor='middle'>✦</text><style>svg{font-family:system-ui,-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,\"Noto Sans\",sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",\"Noto Color Emoji\"}@media(prefers-color-scheme:dark){svg{fill:#fff}}</style></svg>"}]]}],["$","body",null,{"children":["$","$L13",null,{"value":{"children":"$undefined","darkMode":true,"docsRepositoryBase":"https://github.com/oxia-db/oxia-doc/blob/main","editLink":"Edit this page on GitHub","feedback":{"content":"Question? Give us feedback","labels":"feedback"},"i18n":[],"lastUpdated":["$","$L14",null,{}],"navigation":{"next":true,"prev":true},"search":["$","$L15",null,{}],"sidebar":{"defaultMenuCollapseLevel":1,"defaultOpen":true,"toggleButton":true},"themeSwitch":{"dark":"Dark","light":"Light","system":"System"},"toc":{"backToTop":"Scroll to top","float":true,"title":"On This Page"}},"children":["$","$L16",null,{"attribute":"class","defaultTheme":"system","disableTransitionOnChange":true,"storageKey":"theme","children":[["$","$L17",null,{}],"$undefined",["$","$L18",null,{"pageMap":[{"data":{"index":{"display":"hidden"},"docs":{"type":"page","title":"Documentation"}}},{"name":"index","route":"/","frontMatter":{},"title":"Index"},{"name":"docs","route":"/docs","children":[{"data":{"index":{"title":"Getting Started"}}},{"name":"index","route":"/docs","frontMatter":{"title":"Index","filePath":"src/content/index.mdx","timestamp":1750302461000},"title":"Getting Started"},{"name":"architecture","route":"/docs/architecture","children":[{"name":"design-goals","route":"/docs/architecture/design-goals","frontMatter":{"title":"Design goals","filePath":"src/content/architecture/design-goals.mdx","timestamp":1750302461000},"title":"Design goals"},{"name":"logical-architecture","route":"/docs/architecture/logical-architecture","frontMatter":{"title":"Logical Architecture","filePath":"src/content/architecture/logical-architecture.mdx","timestamp":1750302461000},"title":"Logical Architecture"},{"name":"physical-architecture","route":"/docs/architecture/physical-architecture","frontMatter":{"title":"Physical Architecture","filePath":"src/content/architecture/physical-architecture.mdx","timestamp":1750302461000},"title":"Physical Architecture"}],"title":"Architecture"},{"name":"consensus","route":"/docs/consensus","children":[{"name":"replication-coordinator","route":"/docs/consensus/replication-coordinator","frontMatter":{"title":"Coordinator","filePath":"src/content/consensus/replication-coordinator.mdx","timestamp":1750302461000},"title":"Coordinator"},{"name":"replication-protocol","route":"/docs/consensus/replication-protocol","frontMatter":{"title":"Oxia replication protocol","filePath":"src/content/consensus/replication-protocol.mdx","timestamp":1750302461000},"title":"Oxia replication protocol"},{"name":"replication-storage","route":"/docs/consensus/replication-storage","frontMatter":{"title":"Storage","filePath":"src/content/consensus/replication-storage.mdx","timestamp":1750302461000},"title":"Storage"}],"title":"Consensus"},{"name":"correctness","route":"/docs/correctness","children":[{"name":"maelstrom","route":"/docs/correctness/maelstrom","frontMatter":{"title":"Maelstrom","filePath":"src/content/correctness/maelstrom.mdx","timestamp":1750302461000},"title":"Maelstrom"},{"name":"tla+","route":"/docs/correctness/tla+","frontMatter":{"title":"TLA +","filePath":"src/content/correctness/tla+.mdx","timestamp":1750302461000},"title":"TLA +"}],"title":"Correctness"},{"name":"deployment","route":"/docs/deployment","children":[{"name":"bare-metal","route":"/docs/deployment/bare-metal","frontMatter":{"title":"Deploying in the bare metal","filePath":"src/content/deployment/bare-metal.mdx","timestamp":1750302461000},"title":"Deploying in the bare metal"},{"name":"kubernetes","route":"/docs/deployment/kubernetes","frontMatter":{"title":"Deploying in Kubernetes with Oxia cluster Helm chart","filePath":"src/content/deployment/kubernetes.mdx","timestamp":1750302461000},"title":"Deploying in Kubernetes with Oxia cluster Helm chart"},{"name":"kubernetes-oxia-cluster","route":"/docs/deployment/kubernetes-oxia-cluster","frontMatter":{"title":"Kubernetes Resources","filePath":"src/content/deployment/kubernetes-oxia-cluster.mdx","timestamp":1750302461000},"title":"Kubernetes Resources"}],"title":"Deployment"},{"name":"features","route":"/docs/features","children":[{"name":"oxia-key-sorting","route":"/docs/features/oxia-key-sorting","frontMatter":{"title":"Keys Sorting","filePath":"src/content/features/oxia-key-sorting.mdx","timestamp":1750302461000},"title":"Keys Sorting"}],"title":"Features"}],"title":"Documentation"}],"navbar":["$","header",null,{"className":"nextra-navbar x:sticky x:top-0 x:z-30 x:w-full x:bg-transparent x:print:hidden x:max-md:[.nextra-banner:not([class$=hidden])~&]:top-(--nextra-banner-height)","children":[["$","div",null,{"className":"nextra-navbar-blur x:absolute x:-z-1 x:size-full nextra-border x:border-b x:backdrop-blur-md x:bg-nextra-bg/70"}],["$","nav",null,{"style":{"height":"var(--nextra-navbar-height)"},"className":"x:mx-auto x:flex x:max-w-(--nextra-content-width) x:items-center x:gap-4 x:pl-[max(env(safe-area-inset-left),1.5rem)] x:pr-[max(env(safe-area-inset-right),1.5rem)] x:justify-end","children":[["$","$L19",null,{"href":"/","className":"x:flex x:items-center x:me-auto x:transition-opacity x:focus-visible:nextra-focus x:hover:opacity-75","aria-label":"Home page","children":["$","div",null,{"children":[["$","b",null,{"children":"Oxia"}]," ",["$","span",null,{"style":{"opacity":"60%"},"children":"Metadata Store and Coordination System"}]]}]}],["$","$L1a",null,{"className":"","children":["$undefined","$undefined","$undefined"]}]]}]]}],"footer":"$undefined","children":[["$","$L1b",null,{}],["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]]}]]}]}]}]]}]
1c:I[9608,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"TOCProvider"]
1d:I[44502,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"Sidebar"]
1e:I[90911,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"ClientWrapper"]
1f:I[19443,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"HeadingAnchor"]
20:I[56325,["2545","static/chunks/c16f53c3-0378df55f56a4938.js","278","static/chunks/278-f759f12e97fa4c64.js","2847","static/chunks/app/docs/%5B%5B...mdxPath%5D%5D/page-5c4c48bb7174cea3.js"],"Mermaid"]
5:["$","div",null,{"className":"x:mx-auto x:flex x:max-w-(--nextra-content-width)","children":["$","$L1c",null,{"value":[{"value":"Terminology","id":"terminology","depth":2},{"value":"Term","id":"term","depth":3},{"value":"Fencing","id":"fencing","depth":3},{"value":"Truncation","id":"truncation","depth":3},{"value":"Error handling","id":"error-handling","depth":2},{"value":"Follower failure","id":"follower-failure","depth":3},{"value":"Leader failure","id":"leader-failure","depth":3},{"value":"Anatomy of a leadership election","id":"anatomy-of-a-leadership-election","depth":2},{"value":"Fence Nodes","id":"fence-nodes","depth":3},{"value":"Instruction from the coordinator","id":"instruction-from-the-coordinator","depth":4},{"value":"Gathering state from the storage nodes","id":"gathering-state-from-the-storage-nodes","depth":4},{"value":"Assign a Leader","id":"assign-a-leader","depth":3},{"value":"Become Leader","id":"become-leader","depth":4},{"value":"Catch-up followers","id":"catch-up-followers","depth":4},{"value":"Finalize ensemble","id":"finalize-ensemble","depth":3},{"value":"Add followers","id":"add-followers","depth":4},{"value":"Truncate followers","id":"truncate-followers","depth":4},{"value":"Return to steady state","id":"return-to-steady-state","depth":3}],"children":[["$","$L1d",null,{}],["$","$L1e",null,{"metadata":{"title":"Coordinator","filePath":"src/content/consensus/replication-coordinator.mdx","timestamp":1750302461000},"bottomContent":"$undefined","children":[["$","div",null,{"id":"nextra-skip-nav"}],["$","main",null,{"data-pagefind-body":true,"children":[["$","h1",null,{"id":"$undefined","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-bold x:mt-2 x:text-4xl","children":["Coordinator","$undefined"]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"Here we describe the larger part of the replication protocol that is principally concerned with the coordination of\nrelationships between the storage nodes of a cluster."}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"Fundamentally this requires a single coordinator process and a set of storage nodes. It is the responsibility of the\ncoordinator to define and effect the relationships between storage nodes (who is leader, who is a follower). Once the\ncoordinator has done this, the storage nodes are able to work together without further interaction with the coordinator.\nThe coordinator will only get involved again when it deems it necessary to redefine the relationships between the nodes\n(scale up/down, node failure, etc.)"}],"\n",["$","h2",null,{"id":"terminology","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Terminology",["$","$L1f",null,{"id":"terminology"}]]}],"\n",["$","h3",null,{"id":"term","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Term",["$","$L1f",null,{"id":"term"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["A counter belonging to a shard that is incremented every time a new leader selection is ",["$","strong",null,{"children":"started"}]," by the coordinator.\nThe purpose of the term is to allow followers to differentiate between requests that arrive from prior and newly elected\nleaders, thus potentially polluting the log. The term sequence begins at ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"0"}],", with an initial state of ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"-1"}]," designating\nan undefined state. Terms are generated by the coordinator. Typically, only messages tagged with the current term will\nbe acted upon by storage nodes and the rest will be ignored as they must have originated from a system state that likely\nno longer exists. (The only exception is the ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"NewTerm"}]," request which will sync the node into a newer, higher term)."]}],"\n",["$","h3",null,{"id":"fencing","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Fencing",["$","$L1f",null,{"id":"fencing"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["When a new leader election is started, the coordinator stops data replication within the shard. It does this by moving\nfollowers and the leader to the “Fenced” state by sending them a ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"NewTerm"}],". This has the effect of incrementing the\nterm, for all the shard’s nodes and removing the leadership role from the current leader. When in this state, nodes wait\nto either be told to become the leader (via the coordinator), or append entries from a leader (i.e become a follower)."]}],"\n",["$","h3",null,{"id":"truncation","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Truncation",["$","$L1f",null,{"id":"truncation"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"The removal of entries appended in the previous term, from the head of a node’s log, so that its dataset is consistent\nwith that of a leader node. This is required only when, after a leader election, a new follower happens to be ahead of a\nnew leader."}],"\n",["$","h2",null,{"id":"error-handling","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Error handling",["$","$L1f",null,{"id":"error-handling"}]]}],"\n",["$","h3",null,{"id":"follower-failure","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Follower failure",["$","$L1f",null,{"id":"follower-failure"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"If the coordinator detects that a follower is down, it will not perform any action. The ensemble will keep working\nand the leader will still have a majority, required to accept new write requests."}],"\n",["$","h3",null,{"id":"leader-failure","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Leader failure",["$","$L1f",null,{"id":"leader-failure"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"If the leader of a shard fails, the coordinator is responsible to ensure the correctness of the system, and will start\na new leader election."}],"\n",["$","h2",null,{"id":"anatomy-of-a-leadership-election","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Anatomy of a leadership election",["$","$L1f",null,{"id":"anatomy-of-a-leadership-election"}]]}],"\n",["$","blockquote",null,{"className":"x:not-first:mt-[1.25em] x:border-gray-300 x:italic x:text-gray-700 x:dark:border-gray-700 x:dark:text-gray-400 x:border-s-2 x:ps-[1.5em]","children":["\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["As mentioned elsewhere, a ",["$","$L19",null,{"href":"../correctness/correctness","prefetch":"$undefined","className":"x:focus-visible:nextra-focus x:text-primary-600 x:underline x:hover:no-underline x:decoration-from-font x:[text-underline-position:from-font]","children":"formal description"}]," of the protocol is available in\n",["$","a",null,{"href":"https://lamport.azurewebsites.net/tla/tla.html","target":"_blank","rel":"noreferrer","className":"x:focus-visible:nextra-focus x:text-primary-600 x:underline x:hover:no-underline x:decoration-from-font x:[text-underline-position:from-font]","children":["TLA+",[" ",["$","svg",null,{"fill":"none","stroke":"currentColor","strokeLinecap":"round","strokeLinejoin":"round","strokeWidth":1.7,"viewBox":"0 0 24 24","height":"1em","className":"x:inline x:align-baseline x:shrink-0","children":[["$","path",null,{"d":"M7 17L17 7"}],["$","path",null,{"d":"M7 7h10v10"}]]}]]]}],"."]}],"\n"]}],"\n",["$","h3",null,{"id":"fence-nodes","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Fence Nodes",["$","$L1f",null,{"id":"fence-nodes"}]]}],"\n",["$","h4",null,{"id":"instruction-from-the-coordinator","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-xl","children":["Instruction from the coordinator",["$","$L1f",null,{"id":"instruction-from-the-coordinator"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["To rearrange the roles and relationships between a shard’s storage nodes, the coordinator must first bring an end to the\ncurrent arrangement. Concretely, it must bring an end to the current term and signal the start of a leader election. It\ndoes this by sending a shard’s current ensemble of storage nodes a ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"NewTerm"}]," request. Importantly this request includes\nthe value of the new term, which all the nodes are expected to adopt. The leader will take the ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"NewTerm"}]," as a signal of\nthe end of its reign, and at this point it will become a regular node in the new term."]}],"\n",["$","h4",null,{"id":"gathering-state-from-the-storage-nodes","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-xl","children":["Gathering state from the storage nodes",["$","$L1f",null,{"id":"gathering-state-from-the-storage-nodes"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["Nodes in the shard’s ensemble will return a ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"NewTermResponse"}]," to the coordinator. This conveys a key piece of information\n— the node’s ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}]," for the shard — the most recent entry that it was able to write to it’s WAL."]}],"\n",["$","h3",null,{"id":"assign-a-leader","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Assign a Leader",["$","$L1f",null,{"id":"assign-a-leader"}]]}],"\n",["$","h4",null,{"id":"become-leader","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-xl","children":["Become Leader",["$","$L1f",null,{"id":"become-leader"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["The coordinator will assign a leader for the shard as soon as it has a quorum of ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"NewTerm"}]," responses. It does not need\nto wait for responses from the whole ensemble. Now, in this set of responses it the coordinator now has a picture of the\npositions of each of the nodes within the shard data stream via the returned ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}],". To choose a new leader, the\ncoordinator simply picks the node with the most recent entry (the greatest ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}]," from the previous epoch) as it\ncan be assumed to be the closest replica of the previous leader."]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["With a leader selected, the coordinator informs the node in question by passing it a ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"BecomeLeaderRequest"}],". Within the\nrequest it includes the other nodes in the fencing ensemble, and their positions so that the leader can catch-up these\nnew followers."]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["The storage node that is leader will signal its acceptance of leadership by returning a ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"BecomeLeaderResponse"}]," to the\ncoordinator."]}],"\n",["$","h4",null,{"id":"catch-up-followers","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-xl","children":["Catch-up followers",["$","$L1f",null,{"id":"catch-up-followers"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["Given that the followers might be behind the new leader (their ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}]," will be less than that of the leader and\nthey won’t have the most recent entries in their WAL), the leader must now catch-up its followers. Using the information\nprovided in the ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"BecomeLeaderRequest"}]," follower map, the leader can now send and missing entries to followers by opening\na ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"Replicate"}]," stream to them."]}],"\n",["$","blockquote",null,{"className":"x:not-first:mt-[1.25em] x:border-gray-300 x:italic x:text-gray-700 x:dark:border-gray-700 x:dark:text-gray-400 x:border-s-2 x:ps-[1.5em]","children":["\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["⚠️ Note the additional subtext of the ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"Replicate"}]," stream here — it is acting not only as a channel to append entries,\nbut also as a signal to become a follower."]}],"\n"]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["The responses to these requests are described in the ",["$","$L19",null,{"href":"replication-storage","prefetch":"$undefined","className":"x:focus-visible:nextra-focus x:text-primary-600 x:underline x:hover:no-underline x:decoration-from-font x:[text-underline-position:from-font]","children":"storage"}]," section of the protocol. The\nfollower is now in a steady state will receive ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"Append"}]," requests from the leader."]}],"\n",["$","h3",null,{"id":"finalize-ensemble","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Finalize ensemble",["$","$L1f",null,{"id":"finalize-ensemble"}]]}],"\n",["$","blockquote",null,{"className":"x:not-first:mt-[1.25em] x:border-gray-300 x:italic x:text-gray-700 x:dark:border-gray-700 x:dark:text-gray-400 x:border-s-2 x:ps-[1.5em]","children":["\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["🧵 This will occur concurrently with ",["$","strong",null,{"children":"Catch-up followers"}]]}],"\n"]}],"\n",["$","h4",null,{"id":"add-followers","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-xl","children":["Add followers",["$","$L1f",null,{"id":"add-followers"}]]}],"\n",["$","blockquote",null,{"className":"x:not-first:mt-[1.25em] x:border-gray-300 x:italic x:text-gray-700 x:dark:border-gray-700 x:dark:text-gray-400 x:border-s-2 x:ps-[1.5em]","children":["\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["ℹ️ In the TLA+, ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"Append"}]," requests does not have a companion ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"AppendResponse"}],". However, there is an empty stub response\nin the protobuf implementation."]}],"\n"]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["You will recall that only a quorum of nodes is required to assign a leader. This means that some nodes in the shard’s\nensemble are not yet known to the leader. Consequently, the coordinator now instructs the leader to adopt these remaining\nnodes as followers. It does so by sending the leader ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"AddFollowerRequest"}],". Much like the follower map in the\n",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"BecomeLeaderRequest"}],", the ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"AddFollowerRequest"}]," includes information on the nodes ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}],". As before, the leader\nmay have to catch-up the new followers, in which case it’d send ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"Replicate"}]," as described previously."]}],"\n",["$","$L20",null,{"chart":"sequenceDiagram\\nparticipant C as Coordinator\\nparticipant L as Leader\\nparticipant F as Follower_4\\nNote right of L: Newly elected<br/>term:4<br/>head_offset:7\\nC--)L: AddFollowerRequest(Follower_4, ..., follower_head_offset:5)\\nNote right of F: Not in fencing quorum<br/>term:3<br/>head_offset:5\\nL->>F: AddEntryRequest(term:4, head_offset:6)\\nF->>L: AddEntryResponse(offset:6)\\nNote right of L: New FollowCursor<br/>follower:Follower_4<br/>head_offset:6\\nL->>F: AddEntryRequest(term:4, head_offset:7)\\nF->>L: AddEntryResponse(offset:7)\\n"}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"However, another possibility exists…"}],"\n",["$","h4",null,{"id":"truncate-followers","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-xl","children":["Truncate followers",["$","$L1f",null,{"id":"truncate-followers"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["Nodes that were not present in the fencing quorum may have a ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}]," in the ",["$","strong",null,{"children":"previous"}]," term that is more advanced (greater) than that of the new leader. When electing a leader in the fencing quorum, the coordinator so far avoided truncations by choosing the node with the highest ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"head_offset"}]," as leader — meaning that other nodes in the quorum will therefore have lower values and thus not need truncation. However, outside of the fencing quorum this might not hold true; perhaps in the previous term the follower being added now was the leader, or maybe it was a ‘faster’ follower? In this eventuality, the node must be truncated before it can follow so that the log of entries for the prior term are the same on all nodes. Quite simply, the node must dispose of any entries that the leader does not have."]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["The leader instructs followers to truncate by issuing ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"TruncateRequests"}]," to any new followers who require it. When the leader receives ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"TruncateResponses"}]," from followers, it starts ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"[FollowCursors](Storage%203889d3c230e74dcdbbf405f72978a60c.md)"}]," for each follower at the head offset indicated in the respective response."]}],"\n",["$","$L20",null,{"chart":"sequenceDiagram\\nparticipant C as Coordinator\\nparticipant L as Leader\\nparticipant F as Follower_5\\nparticipant FWL as Follower_5<br/>WAL\\nNote right of L: Newly elected<br/>term:4<br/>head_offset:7\\nC--)L: AddFollowerRequest(Follower_5, ..., follower_head_offset:8)\\nNote right of F: Not in fencing quorum<br/>term:3<br/>head_offset:8\\nL->>F: TruncateRequest(term:4, head_offset:7)\\nF->>FWL: TruncateLog(offset:7)\\nFWL->>F: \\nNote right of F: term:4<br/>head_offset:7\\nF->>L: TruncateResponse(..., head_offset:7)\\nNote right of L: New FollowCursor<br/>follower:Follower_5<br/>head_offset:7\\n"}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["After the truncate, the system is in a steady state and followers will receive ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"Append"}]," requests from the leader."]}],"\n",["$","h3",null,{"id":"return-to-steady-state","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["Return to steady state",["$","$L1f",null,{"id":"return-to-steady-state"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"The shard’s node ensemble has returned to a steady state."}]]}]]}]]}]}]
c:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
7:null
a:{"metadata":[["$","title","0",{"children":"Coordinator - Oxia"}],["$","meta","1",{"name":"description","content":"Oxia: Shading Based Metadata Store and Coordination System"}],["$","meta","2",{"name":"application-name","content":"oxia"}],["$","meta","3",{"name":"generator","content":"Next.js"}],["$","meta","4",{"name":"msapplication-TileColor","content":"#fff"}],["$","meta","5",{"name":"mobile-web-app-capable","content":"yes"}],["$","meta","6",{"name":"apple-mobile-web-app-title","content":"Nextra"}],["$","meta","7",{"name":"apple-mobile-web-app-status-bar-style","content":"default"}],["$","link","8",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"32x32"}],["$","link","9",{"rel":"icon","href":"/icon.svg?3f6b49f433789018","type":"image/svg+xml","sizes":"any"}]],"error":null,"digest":"$undefined"}
12:{"metadata":"$a:metadata","error":null,"digest":"$undefined"}
